<script type="text/javascript" src="mraid.js"></script>
<!-- load valgrind -->
<iframe
    id="opinary-iframe"
    class="opinary-iframe"
    scrolling="no"
    marginheight="0"
    frameborder="0"
    no-mw-resize="true"
    allow="fullscreen"
    style="width:100%; height:100vh"
    src=""
    ></iframe>
<script type="text/javascript">
    function update_iframe_url() {
        let MEDIA_URL = 'https://valgrind.pressekompass.net/compasses/hermes/hermes_paket_versand_programmatic_0422';
        var urlparams = "?gdpr=${GDPR}&gdpr_consent=${GDPR_CONSENT_STRING}&voteTag=%clickurl:e%&clickTag=https%3A%2F%2Fadfarm1.adition.com%2Ftrack%3Ftid%3D[CID]%26sid%3D[SID]%26type%3Dimg%26orderid%3D%26itemno%3D%26descr%3D%26quantity%3D%26price%3D%26total%3D%26gdpr%3D${GDPR}%26gdpr_consent%3D${GDPR_CONSENT_40}";
        
        var iframe = document.getElementById('opinary-iframe');
        iframe.src = MEDIA_URL + urlparams;
    }
</script>

<!-- MRAID 1: hide close button -->
<style type="text/css">
    .anx-mraid-close {
        right: -50px !important
    }
</style>

<script type="text/javascript">
var isBifrost = window.frameElement && window.frameElement.className === "opinary-iframe";

if (isBifrost) {
    update_iframe_url();

    function postMessageXandrBridge(propagateDown, propagateUp) {
        const isString = value => typeof value === 'string'

        // copied from https://github.com/opinary/bifrost/blob/master/src/lib/recommendations/xandrAdapter.js
        // TODO: add 'opinary.xandr.macros' to propagateDown
        // TODO: forward xandr postmessage events
        propagateDown = propagateDown.concat(['opinary.xandr.macros']);
        propagateUpAction = ['ready', 'expand', 'set-expand-properties'];

        window.addEventListener('message', function(event) {

            let data = event.data;
            if (isString(event.data)) {
                data = JSON.parse(event.data);
            }

            const type = event.data.type;      
            const action = (data.data ? data.data.action: '');

            if (propagateDown.includes(type)) {
                const iframes = document.getElementsByTagName('iframe');

                if (!iframes.length) return;
                const els = [].slice.call(iframes);

                try {
                    els.forEach(iframe => iframe.contentWindow.postMessage(data, '*'));
                } catch (e) {}
            }


            if (propagateUp.includes(type) || propagateUpAction.includes(action)) {
                window.parent.postMessage(data, '*');
            }
        })
    }
} else {

    function displayAd() {

        // TODO: external SSP hardcoded size ?
        let iframe = document.getElementById('opinary-iframe');
        iframe.style.width = 300;
        iframe.style.height = 300;
        iframe.addEventListener('load', function() {
            iframe.contentWindow.postMessage({
                    type: 'opinary.xandr.macros',
                    macros: {},
                    size: { width: 300, height: 300 },
                },
                '*'
            );
        });

        update_iframe_url();
    }

    // after ensuring mraid.js is loaded, call displayAd
    (function() {
        var success = false;
        if (typeof mraid === 'undefined') {
            (function() {
                var head = document.head,
                    js = document.createElement('script'),
                    s = 'mraid.js';
                js.setAttribute('type', 'text/javascript');
                js.setAttribute('src', s);
                js.onload = function() {
                    displayAd();
                }
                head.appendChild(js);
            })();
        } else {
            if (mraid.getState() === 'loading') {
                mraid.addEventListener('ready', displayAd);
            } else if (mraid.getState() === 'default') {
                displayAd();
            }
            success = true;
        }
        
        return success;
    })();

    window.addEventListener('message', function(event) {
        
        if (typeof event.data === 'string') {
            const data = JSON.parse(event.data);

            if (data.data.action == "ready") {
                const msg = JSON.stringify({
                    data: {
                        action: "setAdData",
                        parameters: {
                            "opinary": 1
                        }
                    }
                });
                let iframe = document.getElementById('opinary-iframe');
                iframe.contentWindow.postMessage(msg, '*');
            }

            if (data.data.action === "expand") {
                mraid.resize();
            }

            if (data.data.action === "set-expand-properties") {
                // TODO: potentially add to midgard. This is needed, adform refuses if offsets are missing
                let properties = Object.assign(data.data.properties, {
                    "offsetX": 0,
                    "offsetY": 0,
                    "allowOffscreen": false
                });
                mraid.setResizeProperties(properties);
            }
        }
    });
}
</script>